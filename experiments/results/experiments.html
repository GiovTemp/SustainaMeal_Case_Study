<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Esperimenti con Ricette</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1>Experiments</h1>
        
        <!-- Form di Selezione -->
        <form id="selectionForm">
            <div class="form-group">
                <label for="recipeSelect">Scegli Ricetta:</label>
                <select class="form-control" id="recipeSelect"></select>
            </div>

            <div class="form-group">
                <label for="nutrientsSelect">Tipo di Nutrienti:</label>
                <select class="form-control" id="nutrientsSelect">
                    <option value="calories [cal], totalFat [g], sodium [mg], dietaryFiber [g], sugars [g], protein [g]">calories [cal], totalFat [g], sodium [mg], dietaryFiber [g], sugars [g], protein [g]</option>
                    <option value="calories [cal], totalFat [g], saturatedFat [g], cholesterol [mg], sodium [mg], dietaryFiber [g], sugars [g], protein [g]">calories [cal], totalFat [g], saturatedFat [g], cholesterol [mg], sodium [mg], dietaryFiber [g], sugars [g], protein [g]</option>
                </select>
            </div>


            <div class="form-group">
                <label for="kSelect">Valore di K:</label>
                <select class="form-control" id="kSelect">
                    <option value="10">10</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="matchAllTagsCheck">
                <label class="form-check-label" for="matchAllTagsCheck">Match All Tags</label>
            </div>
            <button type="button" id="submitButton" class="btn btn-primary">Aggiorna Risultati</button>
        </form>

        <!-- Sezione per i Risultati -->
        <div id="results" class="mt-3">
            <!-- I risultati filtrati saranno visualizzati qui -->
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        const dataUrl = '../../data/experiment_results.json';
        let experimentsData = [];

        function loadExperimentsData() {
            $.getJSON(dataUrl, function(data) {
                experimentsData = data;
                populateRecipeOptions();
            }).fail(function() {
                console.error("Errore nel caricamento dei dati degli esperimenti");
            });
        }

        function populateRecipeOptions() {
            const recipeSelect = $('#recipeSelect');
            recipeSelect.empty();

            let uniqueRecipeNames = new Set();
            experimentsData.forEach(function(experiment) {
                uniqueRecipeNames.add(experiment.recipe_name);
            });

            uniqueRecipeNames.forEach(function(recipeName) {
                recipeSelect.append(new Option(recipeName, recipeName));
            });
        }

        $('#submitButton').click(function() {
            const selectedRecipeName = $('#recipeSelect').val();
            const selectedK = $('#kSelect').val();
            const matchAllTags = $('#matchAllTagsCheck').is(':checked');
            const selectedNutrients = $('#nutrientsSelect').val();

            updateResults(selectedRecipeName, selectedK, matchAllTags, selectedNutrients);
        });

        function updateResults(recipeName, k, matchAllTags,selectedNutrients) {
            const resultsDiv = $('#results');
            resultsDiv.empty();

            let filteredData = experimentsData.filter(function(experiment) {
                return experiment.recipe_name === recipeName &&
                    experiment.k.toString() === k &&
                    experiment.match_all_tags === matchAllTags &&
                    experiment.nutrients === selectedNutrients;
            });


            if (filteredData.length > 0) {
                let inputRecipeHtml
                let detailsHtml = '<div class="input-recipe-details">';
                let resultHtml = '<table class="table">';
                resultHtml += '<thead><tr><th>Nome Ricetta</th><th>who_score</th><th>healthiness_increment</th>'+
                    '<th>sustainability_score</th><th>sustainability_increment</th>'+
                    '<th>sustainameal_score</th><th>sustainameal_score_increment</th>'+
                    '</tr></thead>';
                resultHtml += '<tbody>';

                let totalHealthinessIncrement = 0;
                let totalSustainabilityIncrement = 0;
                let totalSustainamealScoreIncrement = 0;
                let count = 0;

                filteredData.forEach(function(results) {
                    // HTML per mostrare i dettagli della ricetta in input
                  
                    detailsHtml += '<h3>Dettagli Ricetta Selezionata</h3>';
                    detailsHtml += '<p><strong>Nome Ricetta:</strong> ' + results.recipe_name + '</p>';
                    detailsHtml += '<p><strong>ID Ricetta:</strong> ' + results.recipe_id + '</p>';
                    detailsHtml += '<p><strong>Who Score:</strong> ' + results.who_score + '</p>';
                    detailsHtml += '<p><strong>Sustainability Score:</strong> ' + results.sustnability_score + '</p>';
                    detailsHtml += '</div>';


                    results.ordered_by_sustainameal.forEach(function(experiment) {
                        totalHealthinessIncrement += parseFloat(experiment.healthiness_increment);
                        totalSustainabilityIncrement += parseFloat(experiment.sustainability_increment);
                        totalSustainamealScoreIncrement += parseFloat(experiment.sustainameal_score_increment);
                        count++;

                        resultHtml += '<tr>';
                        resultHtml += '<td>' + experiment.title + '</td>';
                        resultHtml += '<td>' + experiment.who_score + '</td>';
                        resultHtml += '<td style="color:' + (experiment.healthiness_increment >= 0 ? 'green' : 'red') + ';">' + experiment.healthiness_increment.toFixed(2) + '% </td>';
                        resultHtml += '<td>' + experiment.sustainability_score + '</td>';
                        resultHtml += '<td style="color:' + (experiment.sustainability_increment >= 0 ? 'green' : 'red') + ';">' + experiment.sustainability_increment.toFixed(2) + '% </td>';
                        resultHtml += '<td>' + experiment.sustainameal_score + '</td>';
                        resultHtml += '<td style="color:' + (experiment.sustainameal_score_increment >= 0 ? 'green' : 'red') + ';">' + experiment.sustainameal_score_increment.toFixed(2) + '% </td>';
                        resultHtml += '</tr>';
                    });
                });

                // Calcola la media degli incrementi
                let averageHealthinessIncrement = (totalHealthinessIncrement / count).toFixed(2);
                let averageSustainabilityIncrement = (totalSustainabilityIncrement / count).toFixed(2);
                let averageSustainamealScoreIncrement = (totalSustainamealScoreIncrement / count).toFixed(2);

                // Aggiungi le medie al tuo HTML
                resultHtml += '<tr>';
                resultHtml += '<td>Media Incrementi:</td>';
                resultHtml += `<td></td>`; // Colonna vuota per allineare con l'intestazione
                resultHtml += `<td style="color:${averageHealthinessIncrement >= 0 ? 'green' : 'red'};">${averageHealthinessIncrement}%</td>`;
                resultHtml += `<td></td>`; // Colonna vuota
                resultHtml += `<td style="color:${averageSustainabilityIncrement >= 0 ? 'green' : 'red'};">${averageSustainabilityIncrement}%</td>`;
                resultHtml += `<td></td>`; // Colonna vuota
                resultHtml += `<td style="color:${averageSustainamealScoreIncrement >= 0 ? 'green' : 'red'};">${averageSustainamealScoreIncrement}%</td>`;
                resultHtml += '</tr>';

                resultHtml += '</tbody></table>';
                resultsDiv.html(detailsHtml + resultHtml);
            } else {
                resultsDiv.html('<p>Nessun risultato corrispondente trovato.</p>');
            }
        }

        $(document).ready(function() {
            loadExperimentsData();
        });
    </script>
</body>
</html>
